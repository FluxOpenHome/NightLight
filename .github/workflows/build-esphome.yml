name: Build ESPHome Firmware

on:
  push:
    branches: [main]
    paths:
      - '**.yaml'

concurrency:
  group: build-firmware
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.device.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        device:
          - name: flux-night-light
            file: flux-night-light.yaml

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build firmware
        uses: esphome/build-action@v7
        id: esphome-build
        continue-on-error: true
        with:
          yaml-file: ${{ matrix.device.file }}

      - name: Save build log on failure
        if: steps.esphome-build.outcome == 'failure'
        run: |
          echo "BUILD FAILED for ${{ matrix.device.file }}" > build-error.log
          echo "See the 'Build firmware' step output above for full compile errors." >> build-error.log

      - name: Auto-fix with Claude
        if: steps.esphome-build.outcome == 'failure'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            The ESPHome firmware build FAILED for ${{ matrix.device.file }}.

            Please:
            1. Read the file ${{ matrix.device.file }} to understand the codebase
            2. Look at the build errors from the GitHub Actions log
            3. Fix ONLY the compile errors — do not refactor or change functionality
            4. Increment the patch version in software_version
            5. Commit and push the fix so the build re-triggers

            IMPORTANT: Only fix compile/syntax errors. Do not change any logic or features.
          claude_args: "--max-turns 10"

      - name: Fail the build if firmware compile failed and Claude couldn't fix
        if: steps.esphome-build.outcome == 'failure'
        run: exit 1

      - name: Get version from YAML
        if: steps.esphome-build.outcome == 'success'
        id: version
        run: |
          VERSION=$(grep 'software_version:' ${{ matrix.device.file }} | head -1 | sed 's/.*"\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION"

      - name: Rename firmware files
        if: steps.esphome-build.outcome == 'success'
        run: |
          mkdir -p output
          mkdir -p firmware
          BUILD_DIR="${{ steps.esphome-build.outputs.name }}"
          VERSION="${{ steps.version.outputs.version }}"
          NAME="${{ matrix.device.name }}"

          # OTA bin → output/ (for GitHub Release)
          for file in "$BUILD_DIR"/*.ota.bin; do
            [ -f "$file" ] && cp "$file" "output/${NAME}-${VERSION}.ota.bin"
          done

          # Factory bin → firmware/ (to commit to repo)
          for file in "$BUILD_DIR"/*.factory.bin; do
            [ -f "$file" ] && cp "$file" "firmware/${NAME}-${VERSION}.factory.bin"
          done

          # Generate MD5 hash for OTA bin
          for file in output/*.ota.bin; do
            [ -f "$file" ] && md5sum "$file" | awk '{print $1}' > "${file}.md5"
          done

          echo "Release files:"
          ls -la output/
          echo "Repo files:"
          ls -la firmware/

      - name: Update manifest.json
        if: steps.esphome-build.outcome == 'success'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NAME="${{ matrix.device.name }}"
          TAG="v${VERSION}"
          MD5=$(cat output/${NAME}-${VERSION}.ota.bin.md5)

          cat > manifest.json << EOF
          {
            "name": "Flux Night Light",
            "version": "${VERSION}",
            "builds": [
              {
                "chipFamily": "ESP32-C3",
                "ota": {
                  "md5": "${MD5}",
                  "path": "https://github.com/FluxOpenHome/NightLight/releases/download/${TAG}/${NAME}-${VERSION}.ota.bin",
                  "release_url": "https://github.com/FluxOpenHome/NightLight/releases/tag/${TAG}",
                  "summary": "Update ${VERSION}"
                }
              }
            ]
          }
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' manifest.json
          echo "Updated manifest.json:"
          cat manifest.json

      - name: Commit factory bin and manifest to repo
        if: steps.esphome-build.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save built files so we can replay on top of latest main
          cp -r firmware/ /tmp/firmware-build
          cp manifest.json /tmp/manifest-build.json

          # Fast-forward to whatever main looks like right now
          git fetch origin main
          git reset --hard origin/main

          # Drop our built files back in and commit
          cp -r /tmp/firmware-build/* firmware/
          cp /tmp/manifest-build.json manifest.json
          git add firmware/ manifest.json
          git diff --cached --quiet || git commit -m "Build: ${NAME} factory bin v${VERSION} [skip ci]

          Auto-built from ${{ github.sha }}"
          git push
        env:
          NAME: ${{ matrix.device.name }}
          VERSION: ${{ steps.version.outputs.version }}

      - name: Upload build artifact
        if: steps.esphome-build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.device.name }}-firmware
          path: |
            output/*.bin
            output/*.md5

      - name: Create GitHub Release
        if: steps.esphome-build.outcome == 'success'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "v${{ steps.version.outputs.version }}"
          body: |
            Automated firmware build for **${{ matrix.device.name }}**

            - Version: `${{ steps.version.outputs.version }}`
            - Commit: ${{ github.sha }}
            - Built: ${{ github.event.head_commit.timestamp }}

            **Files:**
            - `.ota.bin` — OTA update (in release)
            - `.ota.bin.md5` — MD5 checksum for OTA bin
            - `.factory.bin` — Full flash (in `firmware/` folder)
          files: |
            output/*.ota.bin
            output/*.ota.bin.md5
          make_latest: true
